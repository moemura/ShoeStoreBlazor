# Backend Cart Feature Plan (Cache-based, Guest & Sync on Login)

## 1. Cart Storage Strategy

- **Cart data is NOT stored in the database.**
- All cart data is stored in cache (Use `ICacheService` in `Service/Caches`)
- Each cart is identified by:
  - **Guest:** a unique GuestId generated by the frontend (FE) and stored in localStorage.
    - FE generates a UUID (or random string) if not present, stores in localStorage, and sends it in API requests (e.g., via header or body).
  - **Logged-in user:** userId (from JWT).
- On login, guest cart is merged into user cart and guest cart is cleared (FE can remove GuestId from localStorage after merge).

## 2. Data Structures

- **Cart (in cache)**
  - Key: `cart:{userId}` (for logged-in) or `cart:guest:{GuestId}` (for guest, GuestId from FE/localStorage)
  - Value: CartDto (serialized as JSON)

- **CartDto**
  - List<CartItemDto>
  - CreatedAt, UpdatedAt

- **CartItemDto**
  - InventoryId (Product+Size)
  - Quantity
  - ProductName 
  - Size

- **CartItemAddOrUpdateRequest**
  - InventoryId, Quantity

## 3. Service Design

- **ICartService**
  - `Task<CartDto> GetCart(string userIdOrSessionKey)`
  - `Task AddOrUpdateItem(string userIdOrSessionKey, CartItemAddOrUpdateRequest request)`
  - `Task RemoveItem(string userIdOrSessionKey, int inventoryId)`
  - `Task ClearCart(string userIdOrSessionKey)`
  - `Task<int> GetCartItemCount(string userIdOrSessionKey)`
  - `Task MergeGuestCartToUser(string guestSessionKey, string userId)`

- **CartService**
  - All methods operate on cache.
  - When user logs in, call `MergeGuestCartToUser` to merge guest cart into user cart, then clear guest cart.
  - Always check inventory before adding/updating items.

## 4. Controller

- **CartController**
  - API endpoints for all service methods.
  - For guests: use GuestId from FE (localStorage, sent via header/body).
  - For logged-in: use userId from JWT.
  - Endpoint for merging guest cart on login (FE sends both GuestId and JWT).

## 5. Implementation Steps

1. **DTOs**
   - Define `CartDto`, `CartItemDto` in `Models/DTOs` if not exist.
2. **Service**
   - Create `ICartService` and `CartService` in `Services/Carts`.
   - Use distributed cache (e.g., IDistributedCache/IMemoryCache).
   - Implement merge logic for guest-to-user cart.
3. **Controller**
   - Create `CartController` in `Controllers`.
   - Implement endpoints for all cart actions.
   - Add endpoint for cart merge on login.
4. **Session/Token Handling**
   - Middleware or helper to extract session key or userId.
   - Generate session key for new guests if not present.
5. **Register Service**
   - Register `CartService` in `Program.cs` (DI).
6. **Testing**
   - Unit tests for service logic, especially merge and cache operations.

## 6. Notes
- Validate inventory quantity before add or update cart
- Cart data in cache should have an expiration (e.g., 7 days).
- On login, merge guest cart into user cart:
  - For each item in guest cart, add to user cart (sum quantities if same inventory).
  - Remove guest cart from cache after merge.
- Always validate inventory before adding/updating items.
